# Dockerfile for PostgreSQL 18 with steep_repl extension
# Multi-stage build to keep final image small
#
# Build context should be the repository root:
#   docker build -f tests/integration/repl/Dockerfile.pg18-pgrx -t steep-pg18-pgrx .

# Stage 1: Build the extension
FROM postgres:18-bookworm AS builder

RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    pkg-config \
    libssl-dev \
    libreadline-dev \
    zlib1g-dev \
    libclang-dev \
    clang \
    git \
    postgresql-server-dev-18 \
    && rm -rf /var/lib/apt/lists/*

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Install cargo-pgrx
RUN cargo install --locked cargo-pgrx --version "=0.16.1"

# Initialize pgrx
RUN cargo pgrx init --pg18 /usr/bin/pg_config

# Copy and build extension
WORKDIR /build
COPY extensions/steep_repl/ ./
RUN cargo pgrx install --release --pg-config /usr/bin/pg_config

# Stage 2: Final image with just PostgreSQL and the extension
FROM postgres:18-bookworm

# Copy the compiled extension files from builder
COPY --from=builder /usr/share/postgresql/18/extension/steep_repl* /usr/share/postgresql/18/extension/
COPY --from=builder /usr/lib/postgresql/18/lib/steep_repl.so /usr/lib/postgresql/18/lib/

# Copy Chinook sample database SQL files
COPY tests/integration/repl/testdata/chinook/ /docker-entrypoint-initdb.d/chinook/

# Init scripts use numeric prefixes for reliable ordering across all locales.
#
# Order:
# 1. 001-init-steep-repl.sh - Create extension in postgres, create testdb, register it
# 2. 002-init-testdb.sql - Create extension in testdb
# 3. 003-load-chinook.sh - Load Chinook sample databases

# Step 1: Bash script to handle conditional database creation
# This handles both cases: POSTGRES_DB set (testdb exists) or not set (need to create)
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "Creating steep_repl extension in postgres (central catalog)..."\n\
psql -v ON_ERROR_STOP=1 -U "$POSTGRES_USER" -d postgres <<EOF\n\
CREATE EXTENSION IF NOT EXISTS steep_repl;\n\
EOF\n\
\n\
# Create testdb if it does not exist (POSTGRES_DB may have already created it)\n\
echo "Creating testdb database if needed..."\n\
psql -U "$POSTGRES_USER" -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '\''testdb'\''" | grep -q 1 || psql -U "$POSTGRES_USER" -d postgres -c "CREATE DATABASE testdb;"\n\
\n\
echo "Registering testdb in central catalog..."\n\
psql -v ON_ERROR_STOP=1 -U "$POSTGRES_USER" -d postgres <<EOF\n\
INSERT INTO steep_repl.databases (datname) VALUES ('\''testdb'\'')\n\
ON CONFLICT (datname) DO UPDATE SET enabled = true, registered_at = now();\n\
EOF\n\
\n\
echo "steep_repl initialization complete!"\n\
' > /docker-entrypoint-initdb.d/001-init-steep-repl.sh && chmod +x /docker-entrypoint-initdb.d/001-init-steep-repl.sh

# Step 2: Create extension in testdb (database created by step 1)
RUN echo '\\c testdb\n\
-- Install steep_repl extension in testdb\n\
CREATE EXTENSION IF NOT EXISTS steep_repl;\n' > /docker-entrypoint-initdb.d/002-init-testdb.sql

# Step 3: Load Chinook sample databases
# Note: SQL files already have correct database names (chinook_serial, chinook_auto_increment, chinook)
# We only rename chinook_auto_increment -> chinook_identity for clarity
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
# Load Chinook with Serial PKs (already named chinook_serial in SQL file)\n\
echo "Loading Chinook database (serial PKs)..."\n\
psql -U "$POSTGRES_USER" -d postgres -v ON_ERROR_STOP=1 -f /docker-entrypoint-initdb.d/chinook/Chinook_PostgreSql_SerialPKs.sql\n\
\n\
# Load Chinook with Auto-increment PKs - rename to chinook_identity\n\
echo "Loading Chinook database (identity PKs)..."\n\
sed "s/chinook_auto_increment/chinook_identity/g" \\\n\
    /docker-entrypoint-initdb.d/chinook/Chinook_PostgreSql_AutoIncrementPKs.sql | psql -U "$POSTGRES_USER" -d postgres -v ON_ERROR_STOP=1\n\
\n\
# Load original Chinook (already named chinook in SQL file)\n\
echo "Loading Chinook database (plain PKs)..."\n\
psql -U "$POSTGRES_USER" -d postgres -v ON_ERROR_STOP=1 -f /docker-entrypoint-initdb.d/chinook/Chinook_PostgreSql.sql\n\
\n\
echo "Chinook databases loaded successfully!"\n\
' > /docker-entrypoint-initdb.d/003-load-chinook.sh && chmod +x /docker-entrypoint-initdb.d/003-load-chinook.sh

USER postgres
WORKDIR /var/lib/postgresql/data

# Start PostgreSQL with shared_preload_libraries to load steep_repl at server startup
# This is required for shared memory initialization and background worker functionality
CMD ["postgres", "-c", "shared_preload_libraries=steep_repl"]
