# Contracts: Query Performance Monitoring

This file is generated by /speckit.plan - do not edit manually

```go
package contracts

import (
	"context"
	"time"
)

// QueryStats represents aggregated statistics for a normalized query pattern
type QueryStats struct {
	Fingerprint     uint64
	NormalizedQuery string
	Calls           int64
	TotalTimeMs     float64
	MinTimeMs       *float64
	MaxTimeMs       *float64
	TotalRows       int64
	FirstSeen       time.Time
	LastSeen        time.Time
}

// MeanTimeMs returns average execution time
func (q *QueryStats) MeanTimeMs() float64 {
	if q.Calls == 0 {
		return 0
	}
	return q.TotalTimeMs / float64(q.Calls)
}

// QueryEvent represents a single query execution from log or sample
type QueryEvent struct {
	Query      string
	DurationMs float64
	Rows       int64
	Timestamp  time.Time
	Database   string
	User       string
}

// SortField defines the column to sort query results by
type SortField int

const (
	SortByTotalTime SortField = iota
	SortByCalls
	SortByRows
	SortByMeanTime
)

// QueryStatsStore defines the persistence interface for query statistics
type QueryStatsStore interface {
	// Initialize creates tables and indexes if they don't exist
	Initialize(ctx context.Context) error

	// Upsert inserts a new query stat or updates existing one
	Upsert(ctx context.Context, fingerprint uint64, query string, event QueryEvent) error

	// UpsertBatch inserts/updates multiple query stats in a transaction
	UpsertBatch(ctx context.Context, events []struct {
		Fingerprint uint64
		Query       string
		Event       QueryEvent
	}) error

	// GetTopQueries returns top N queries sorted by specified field
	GetTopQueries(ctx context.Context, sortBy SortField, limit int) ([]QueryStats, error)

	// SearchQueries returns queries matching regex pattern
	SearchQueries(ctx context.Context, pattern string, sortBy SortField, limit int) ([]QueryStats, error)

	// GetByFingerprint returns a single query stat by fingerprint
	GetByFingerprint(ctx context.Context, fingerprint uint64) (*QueryStats, error)

	// Cleanup removes records older than retention period
	Cleanup(ctx context.Context, retention time.Duration) (int64, error)

	// Reset deletes all statistics
	Reset(ctx context.Context) error

	// Close releases database resources
	Close() error
}

// DataSourceType indicates the collection method
type DataSourceType int

const (
	DataSourceLogParsing DataSourceType = iota
	DataSourceActivitySampling
)

// DataSourceStatus indicates collection health
type DataSourceStatus int

const (
	DataSourceActive DataSourceStatus = iota
	DataSourceDegraded
	DataSourceUnavailable
)

// DataSource represents runtime collection state
type DataSource struct {
	Type      DataSourceType
	Status    DataSourceStatus
	LastError string
}

// QueryCollector defines the interface for collecting query events
type QueryCollector interface {
	// Start begins collecting query events
	Start(ctx context.Context) error

	// Events returns channel of query events
	Events() <-chan QueryEvent

	// Status returns current data source status
	Status() DataSource

	// EnableLogging attempts to enable PostgreSQL query logging
	// Returns error if insufficient permissions
	EnableLogging(ctx context.Context) error

	// Stop halts collection and releases resources
	Stop() error
}

// QueryFingerprinter normalizes and fingerprints SQL queries
type QueryFingerprinter interface {
	// Fingerprint returns normalized query and uint64 hash
	Fingerprint(query string) (normalized string, fingerprint uint64, err error)
}

// ExplainResult represents a cached EXPLAIN plan
type ExplainResult struct {
	Fingerprint uint64
	PlanJSON    string
	FetchedAt   time.Time
}

// ExplainCache provides caching for EXPLAIN plans
type ExplainCache interface {
	// Get retrieves cached plan if present and not expired
	Get(fingerprint uint64) (*ExplainResult, bool)

	// Set stores a plan in cache
	Set(result ExplainResult)

	// Clear removes all cached plans
	Clear()
}

// ClipboardWriter provides clipboard access
type ClipboardWriter interface {
	// Write copies text to system clipboard
	Write(text string) error

	// Available returns true if clipboard is accessible
	Available() bool
}
```
